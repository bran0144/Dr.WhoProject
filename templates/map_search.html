{% extends 'base.html' %}
{% block head %}
<link rel="stylesheet" href="/static/style.css">

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

<script
defer
src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap&libraries=&v=weekly">
</script>

<script>
  const locations = {{ locations|tojson|safe }};

</script>
<script>

let map;

function initMap() {
  const map = new google.maps.Map(document.getElementById("searched_map"), {
    center: { lat: 51.509865, lng: -0.118092 },
    zoom: 5,
  });

  locations.forEach(location => {
    const address = location.address;
    const latLng = {'lat': Number(location.latitude), 'lng': Number(location.longitude)};
    const location_ep_id = location.ep_id;
    const location_id = location.location_id;
   
    const locationMarker = new google.maps.Marker({
        position: latLng,
        location_ep_id: location_ep_id,
        location_id: location_id,
        map: map,
        icon: {
                url: "/static/img/tardis.png",
                size:new google.maps.Size(20, 34)}
    });
    const locationInfo = new google.maps.InfoWindow();
      $.get('/episodes.json', (episodes => {
        for (const episode of episodes) {
         
          const ep_id = episode.ep_id;
          locationMarker.get(location_ep_id)
          //TODO need to connect ep_id to location_ep_id
          const locationInfoContent = (
          <div class="window-content">
              <ul class="location-info">
                <li><b>Season</b>${episode.season}</li>
                <li><b>Episode Number</b>${episode.episode_number}</li>
                <li><b>Doctor</b>${episode.doctor}</li>
                <li><b>Title</b>${episode.title}</li>
                <li><b>IMDB Link</b>${episode.imdb}</li>
              </ul>
          </div>
          ); 
         
          locationMarker.addEventListener('mouseover', () => {
            locationInfo.close();
            locationInfo.setContent(locationInfoContent);
            locationInfo.open(map, locationMarker);
          });
          // need a mouseout event listener to close infowindow?
}) 
 
// TODO: Need another event listener for click that takes location_id
// and sends as a get to single_map route to render single_map page

</script>
{% endblock %}
{% block body %}
{% block navbar %} {% endblock %}

 
      <div id="searched_map"></div>


{% endblock %} 
